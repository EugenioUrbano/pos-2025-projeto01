{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Boletim Escolar</h2>

    <form method="get" class="mb-4 p-3 border rounded bg-light">
        <div class="row g-3 align-items-end">
            <div class="col-md-9">
                <label for="ano" class="form-label">Ano Letivo</label>
                <select name="ano" id="ano" class="form-select">
                    {% set anos = periods | map(attribute='ano_letivo') | unique | sort(reverse=True) %}
                    {% for a in anos %}
                        <option value="{{ a }}" {% if ano_selecionado == a %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
        </div>
    </form>

    {% if boletim and boletim|length > 0 %}
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th scope="col" class="text-start" style="width: 35%;">Disciplina</th>
                        <th scope="col">C.H.</th>
                        <th scope="col">Faltas</th>
                        <th scope="col">1B</th>
                        <th scope="col">2B</th>
                        <th scope="col">3B</th>
                        <th scope="col">4B</th>
                        <th scope="col">M√©dia</th>
                        <th scope="col" class="text-start">Situa√ß√£o</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    {% for d in boletim %}
                        <tr>
                            <td class="text-start fw-bold">
                                {% if d.disciplina is mapping and d.disciplina.descricao %}
                                    {{ d.disciplina.descricao }}
                                {% elif d.diario and d.diario.disciplina and d.diario.disciplina.descricao %}
                                    {{ d.diario.disciplina.descricao }}
                                {% elif d.disciplina is string %}
                                    {{ d.disciplina }}
                                {% else %}
                                    {{ d.componente_curricular | default('N/A') }}
                                {% endif %}
                            </td>
                            <td>{{ d.carga_horaria_normalizada }}</td>
                            <td>{{ d.numero_faltas | default('N/A', true) }}</td>
                            <td>{{ d.nota_etapa_1.nota | default('‚Äì', true) }}</td>
                            <td>{{ d.nota_etapa_2.nota | default('‚Äì', true) }}</td>
                            <td>{{ d.nota_etapa_3.nota | default('‚Äì', true) }}</td>
                            <td>{{ d.nota_etapa_4.nota | default('‚Äì', true) }}</td>
                            <td>
                                <strong>{{ d.media_final_disciplina | default(d.nota_final, true) | default('‚Äì', true) }}</strong>
                            </td>
                            {% set situacao_class = 'text-success' if 'Aprovado' in d.situacao else 'text-danger' if 'Reprovado' in d.situacao else 'text-secondary' %}
                            <td class="{{ situacao_class }} text-start">
                                <strong>{{ d.situacao | default('Cursando', true) }}</strong>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning mt-4">
            <h4 class="alert-heading">Nenhum boletim encontrado!</h4>
            <p>N√£o h√° dados de boletim registrados para o ano de <strong>{{ ano_selecionado }}</strong>.</p>
        </div>
        <div class="mt-4">
             <h5>üîç Dados brutos recebidos da API (Debug):</h5>
             <pre class="bg-dark text-white p-3 rounded"><code>{{ boletim | tojson(indent=2) }}</code></pre>
        </div>
    {% endif %}
</div>
{% endblock %}
