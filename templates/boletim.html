{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Boletim Escolar</h2>

    <form method="get" class="mb-4 p-3 border rounded bg-light">
        <div class="row g-3 align-items-end">
            <div class="col-md-9">
                <label for="ano" class="form-label">Ano Letivo</label>
                <select name="ano" id="ano" class="form-select">
                    {% set anos = periods | map(attribute='ano_letivo') | unique | sort(reverse=True) %}
                    {% for a in anos %}
                        <option value="{{ a }}" {% if ano_selecionado == a %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
        </div>
    </form>

    {% if boletim and boletim|length > 0 %}
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th class="text-start">Disciplina</th>
                        <th>C.H.</th>
                        <th>Total de Aulas</th>
                        <th>Faltas</th>
                        <th>% Freq.</th>
                        <th>1¬∫ Bim</th>
                        <th>2¬∫ Bim</th>
                        <th>3¬∫ Bim</th>
                        <th>4¬∫ Bim</th>
                        <th>M√©dia Final</th>
                        <th>Situa√ß√£o</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    {% for d in boletim %}
                        <tr>
                            <td class="text-start fw-bold">
                                {% if d.disciplina is mapping and d.disciplina.descricao %}
                                    {{ d.disciplina.descricao }}
                                {% elif d.diario and d.diario.disciplina and d.diario.disciplina.descricao %}
                                    {{ d.diario.disciplina.descricao }}
                                {% elif d.disciplina is string %}
                                    {{ d.disciplina }}
                                {% else %}
                                    {{ d.componente_curricular | default('N/A') }}
                                {% endif %}
                            </td>
                            <td>{{ d.carga_horaria_normalizada }} aulas</td>
                            <td>{{ d.total_aulas_dadas }}</td>
                            <td>{{ d.faltas_normalizadas }}</td>
                            <td>
                                {% if d.total_aulas_dadas > 0 %}
                                    {{ ((d.total_aulas_dadas - d.faltas_normalizadas) / d.total_aulas_dadas * 100) | round(0) }}%
                                {% else %}
                                    100%
                                {% endif %}
                            </td>
                            <td>{{ (d.notas[0].nota if d.notas|length >= 1 else '-') or '-' }}</td>
                            <td>{{ (d.notas[1].nota if d.notas|length >= 2 else '-') or '-' }}</td>
                            <td>{{ (d.notas[2].nota if d.notas|length >= 3 else '-') or '-' }}</td>
                            <td>{{ (d.notas[3].nota if d.notas|length >= 4 else '-') or '-' }}</td>
                            <td><strong>{{ d.media_final if d.media_final not in [None, 'None', 'null', ''] else '-' }}</strong></td>
                            {% if d.situacao == "Aprovado" %}
                                <td class="bg-success text-black">{{ d.situacao }}</td>
                            {% elif d.situacao == "Reprovado" %}
                                <td class="bg-danger text-black">{{ d.situacao }}</td>
                            {% elif d.situacao == "Cursando" %}
                                <td class="bg-warning text-black">{{ d.situacao }}</td>
                            {% else %}
                                <td>{{ d.situacao or "-" }}</td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary fw-bold text-center">
                    <tr>
                        <td class="text-start">Totais</td>
                        <td>{{ total_ch }} aulas</td>
                        <td>{{ total_aulas_dadas }}</td>
                        <td>{{ total_faltas }}</td>
                        <td>{{ "%.2f"|format(frequencia) }}%</td>
                        <td colspan="6"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning mt-4">
            <h4 class="alert-heading">Nenhum boletim encontrado!</h4>
            <p>N√£o h√° dados de boletim registrados para o ano de <strong>{{ ano_selecionado }}</strong>.</p>
        </div>
        <div class="mt-4">
             <h5>üîç Dados brutos recebidos da API (Debug):</h5>
             <pre class="bg-dark text-white p-3 rounded"><code>{{ boletim | tojson(indent=2) }}</code></pre>
        </div>
    {% endif %}
</div>
{% endblock %}
